<!DOCTYPE html>
<html>
  <head>
    <title>Kinect</title>
  </head>
  <body>
    <canvas id="rgbCanvas" width="1920" height="1080" style="height: 400px"></canvas>
    <canvas id="depthCanvas" width="512" height="424" style="height: 400px"></canvas>
    <script>
    (function(){
      var Kinect2 = require('kinect2');
      var kinect = new Kinect2();

      function ColorRenderer(outputCanvas) {
        this.canvas = outputCanvas;
        this.ctx = this.canvas.getContext('2d');
        this.imageData = this.ctx.createImageData(this.canvas.width, this.canvas.height);
        this.imageDataSize = this.imageData.data.length;
        this.imageDataArray = this.imageData.data;

        this.update = function(newPixelData) {
          for (var i = 0; i < this.imageDataSize; i++) {
            this.imageDataArray[i] = newPixelData[i];
          }
          this.ctx.putImageData(this.imageData, 0, 0);
        }
      }

      function GrayscaleRenderer(outputCanvas) {
        this.canvas = outputCanvas;
        this.ctx = this.canvas.getContext('2d');
        this.imageData = this.ctx.createImageData(this.canvas.width, this.canvas.height);
        this.imageDataSize = this.imageData.data.length;
        this.imageDataArray = this.imageData.data;

        this.update = function(newPixelData) {
          var pixelIndex = 0;
          for (var i = 0; i < this.imageDataSize; i+=4) {
            this.imageDataArray[i] = newPixelData[pixelIndex];
            this.imageDataArray[i+1] = newPixelData[pixelIndex];
            this.imageDataArray[i+2] = newPixelData[pixelIndex];
            this.imageDataArray[i+3] = 0xff;
            pixelIndex++;
          }
          this.ctx.putImageData(this.imageData, 0, 0);
        }
      }

      var rgbRenderer = new ColorRenderer(document.getElementById('rgbCanvas'));
      var depthRenderer = new GrayscaleRenderer(document.getElementById('depthCanvas'));

      if(kinect.open()) {
        console.log('kinect open');
        kinect.on('multiSourceFrame', function(frame){
          rgbRenderer.update(frame.color.buffer);
          depthRenderer.update(frame.depth.buffer);
        });
        kinect.openMultiSourceReader({
          frameTypes: Kinect2.FrameType.color | Kinect2.FrameType.depth
        });
      }
    })();
    </script>
  </body>
</html>