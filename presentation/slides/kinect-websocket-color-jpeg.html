<template>
<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist">
  <li role="presentation" class="active"><a href="#" aria-controls="node" role="tab">Node</a></li>
  <li role="presentation"><a href="#" aria-controls="html" role="tab">HTML</a></li>
  <li role="presentation"><a href="#" aria-controls="output" role="tab">Output</a></li>
</ul>

<!-- Tab panes -->
<div class="tab-content" style="position: absolute; width: 100%; top: 62px; bottom: 0;">
  <div role="tabpanel" class="tab-pane active" data-tab-id="node" style="height: 100%;">
    <div class="split-pane fixed-bottom">
      <div class="split-pane-component top-pane" style="bottom: 10em; margin-bottom: 5px; min-height: 5em;">
        <textarea data-id="node-code" data-type="code" data-runtime="node" data-console="node-console">var Kinect2 = require('kinect2'),
  express = require('express'),
  app = express(),
  server = require('http').createServer(app),
  io = require('socket.io').listen(server),
  lwip = require('lwip');

var kinect = new Kinect2();

if(kinect.open()) {
  server.listen(8000);
  console.log('Server listening on port 8000');
  console.log('Point your browser to http://localhost:8000');

  var w = 1920;
  var h = 1080;

  var size = 4 * w * h;
  var channelSize = size / 4;
  var redOffset = 0;
  var greenOffset = channelSize;
  var blueOffset = channelSize * 2;
  var alphaOffset = channelSize * 3;
  var lwipBuffer = new Buffer(size);

  var frameNr = 0;
  var compressing = false;

  kinect.on('colorFrame', function(colorFrame){
    if(compressing) {
      return;
    }
    compressing = true;
    console.log('send colorFrame', ++frameNr);
    //swap colorFrame to lwip buffer
    for(var i = 0; i &lt; channelSize; i++) {
      lwipBuffer[i + redOffset] = colorFrame[i * 4];
      lwipBuffer[i + greenOffset] = colorFrame[i * 4 + 1];
      lwipBuffer[i + blueOffset] = colorFrame[i * 4 + 2];
      lwipBuffer[i + alphaOffset] = 100;
    }
    lwip.open(lwipBuffer, {width: w, height: h}, function(err, image){
      if(err) {
        compressing = false;
        return;
      }
      image.batch()
        .toBuffer('jpg', { quality: 50 }, function(err, buffer){
          if(err) {
            compressing = false;
            return;
          }
          for(var socketId in io.sockets.sockets) {
            io.sockets.sockets[socketId].volatile.emit('colorFrame', buffer);
          }
          compressing = false;
        });
    });
  });

  kinect.openColorReader();
}
</textarea>
        <button class="btn btn-default" data-type="run-button" data-target="node-code" style="position: absolute; top: 1em; right: 1em; z-index: 10">Run</button>
      </div>
      <div class="split-pane-divider divider" style="background: #aaa; bottom: 10em; height: 5px;"></div>
      <div class="split-pane-component bottom-pane" style="height: 10em; min-height: 10em;">
        <div data-id="node-console" style="height: 100%" data-type="console"></div>
      </div>
    </div>
  </div>
  <div role="tabpanel" class="tab-pane" data-tab-id="html" style="height: 100%;">
    <textarea data-id="html-code" data-type="code" data-runtime="web" data-mode="htmlmixed" data-language="html" data-processor="web-preview"><!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Node Kinect2 Client</title>
  <link rel="stylesheet" href="">
</head>
<body>
  <canvas id="outputCanvas" width="1920" height="1080" style="width: 100%"></canvas>
  <script src="http://localhost:8000/socket.io/socket.io.js"></script>
  <script>
    var socket = io.connect('http://localhost:8000');
    var canvas = document.getElementById('outputCanvas');
    var ctx = canvas.getContext('2d');
    var frameNr = 0;
    var img = document.createElement('img');

    socket.on('colorFrame', function(colorFrame){
      console.log('colorFrame', ++frameNr);
      img.src = 'data:image/jpeg;base64,' + base64ArrayBuffer(colorFrame);
      ctx.drawImage(img, 0, 0);
    });

    function base64ArrayBuffer(arrayBuffer) {
      var base64    = ''
      var encodings = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/'

      var bytes         = new Uint8Array(arrayBuffer)
      var byteLength    = bytes.byteLength
      var byteRemainder = byteLength % 3
      var mainLength    = byteLength - byteRemainder

      var a, b, c, d
      var chunk

      // Main loop deals with bytes in chunks of 3
      for (var i = 0; i < mainLength; i = i + 3) {
      // Combine the three bytes into a single integer
      chunk = (bytes[i] << 16) | (bytes[i + 1] << 8) | bytes[i + 2]

      // Use bitmasks to extract 6-bit segments from the triplet
      a = (chunk & 16515072) >> 18 // 16515072 = (2^6 - 1) << 18
      b = (chunk & 258048)   >> 12 // 258048   = (2^6 - 1) << 12
      c = (chunk & 4032)     >>  6 // 4032     = (2^6 - 1) << 6
      d = chunk & 63               // 63       = 2^6 - 1

      // Convert the raw binary segments to the appropriate ASCII encoding
      base64 += encodings[a] + encodings[b] + encodings[c] + encodings[d]
      }

      // Deal with the remaining bytes and padding
      if (byteRemainder == 1) {
      chunk = bytes[mainLength]

      a = (chunk & 252) >> 2 // 252 = (2^6 - 1) << 2

      // Set the 4 least significant bits to zero
      b = (chunk & 3)   << 4 // 3   = 2^2 - 1

      base64 += encodings[a] + encodings[b] + '=='
      } else if (byteRemainder == 2) {
      chunk = (bytes[mainLength] << 8) | bytes[mainLength + 1]

      a = (chunk & 64512) >> 10 // 64512 = (2^6 - 1) << 10
      b = (chunk & 1008)  >>  4 // 1008  = (2^6 - 1) << 4

      // Set the 2 least significant bits to zero
      c = (chunk & 15)    <<  2 // 15    = 2^4 - 1

      base64 += encodings[a] + encodings[b] + encodings[c] + '='
      }

      return base64
    }
  </script>
</body>
</html>
</textarea>
    <button class="btn btn-default" data-type="run-button" data-target="html-code" style="position: absolute; top: 1em; right: 1em; z-index: 10">Run</button>
  </div>
  <div role="tabpanel" class="tab-pane" data-tab-id="output" style="height: 100%;">
    <div class="split-pane fixed-bottom">
      <div class="split-pane-component top-pane" style="bottom: 3em; margin-bottom: 5px; min-height: 5em;">
        <div data-id="web-preview" data-type="web-preview" data-console="web-preview-console"></div>
      </div>
      <div class="split-pane-divider divider" style="background: #aaa; bottom: 3em; height: 5px;"></div>
      <div class="split-pane-component bottom-pane" style="height: 3em; min-height: 3em;">
        <div data-id="web-preview-console" style="height: 100%" data-type="console"></div>
      </div>
    </div>
  </div>
</div>
<script>
(function(){

  var LiveCode = require('slides/LiveCode');
  var $slideHolder = $(document.currentScript).closest('.slide-frame');

  function init() {
    var liveCode = new LiveCode($slideHolder);

    //manual manage tabs, as we don't want to work with element ids
    $slideHolder.find('a[role=tab]').click(function (e) {
      e.preventDefault();
      var tabId = $(e.target).attr('aria-controls');
      var $tab = $slideHolder.find('[data-tab-id="' + tabId + '"]');
      $slideHolder.find(".nav-tabs .active, .tab-content .active").removeClass("active");
      $(e.target).closest('li').addClass('active');
      $tab.addClass("active");
      liveCode.layout();
    });
    $slideHolder.find('div.split-pane').splitPane();
    $slideHolder.find('div.split-pane').on('resize', function(){
      liveCode.layout();
    });

    //focus webpreview tab on run click
    $slideHolder.find('[data-type="run-button"][data-target="html-code"]').on('click', function(){
      $slideHolder.find('a[role=tab][aria-controls=output]').click();
    });

    requestAnimationFrame(function(){
      $slideHolder.find('a[role=tab]').first().click();
    });
  }

  init();

})();
</script>
</template>
