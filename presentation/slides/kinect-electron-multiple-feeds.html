<template>
<!-- Nav tabs -->
<ul class="nav nav-tabs" role="tablist">
  <li role="presentation"><a href="#" aria-controls="html" role="tab">HTML</a></li>
  <li role="presentation"><a href="#" aria-controls="output" role="tab">Output</a></li>
</ul>

<!-- Tab panes -->
<div class="tab-content" style="position: absolute; width: 100%; top: 62px; bottom: 0;">
  <div role="tabpanel" class="tab-pane" data-tab-id="html" style="height: 100%;">
    <textarea data-id="html-code" data-type="code" data-runtime="web" data-mode="htmlmixed" data-language="html" data-processor="web-preview"><!DOCTYPE html>
<html>
  <head>
    <title>Kinect</title>
  </head>
  <body>
    <canvas id="rgbCanvas" width="1920" height="1080" style="height: 400px"></canvas>
    <canvas id="depthCanvas" width="512" height="424" style="height: 400px"></canvas>
    <script>
    (function(){
      var Kinect2 = require('kinect2');
      var kinect = new Kinect2();

      function ColorRenderer(outputCanvas) {
        this.canvas = outputCanvas;
        this.ctx = this.canvas.getContext('2d');
        this.imageData = this.ctx.createImageData(this.canvas.width, this.canvas.height);
        this.imageDataSize = this.imageData.data.length;
        this.imageDataArray = this.imageData.data;

        this.update = function(newPixelData) {
          for (var i = 0; i < this.imageDataSize; i++) {
            this.imageDataArray[i] = newPixelData[i];
          }
          this.ctx.putImageData(this.imageData, 0, 0);
        }
      }

      function GrayscaleRenderer(outputCanvas) {
        this.canvas = outputCanvas;
        this.ctx = this.canvas.getContext('2d');
        this.imageData = this.ctx.createImageData(this.canvas.width, this.canvas.height);
        this.imageDataSize = this.imageData.data.length;
        this.imageDataArray = this.imageData.data;

        this.update = function(newPixelData) {
          var pixelIndex = 0;
          for (var i = 0; i < this.imageDataSize; i+=4) {
            this.imageDataArray[i] = newPixelData[pixelIndex];
            this.imageDataArray[i+1] = newPixelData[pixelIndex];
            this.imageDataArray[i+2] = newPixelData[pixelIndex];
            this.imageDataArray[i+3] = 0xff;
            pixelIndex++;
          }
          this.ctx.putImageData(this.imageData, 0, 0);
        }
      }

      var rgbRenderer = new ColorRenderer(document.getElementById('rgbCanvas'));
      var depthRenderer = new GrayscaleRenderer(document.getElementById('depthCanvas'));

      if(kinect.open()) {
        console.log('kinect open');
        kinect.on('multiSourceFrame', function(frame){
          rgbRenderer.update(frame.color.buffer);
          depthRenderer.update(frame.depth.buffer);
        });
        kinect.openMultiSourceReader({
          frameTypes: Kinect2.FrameType.color | Kinect2.FrameType.depth
        });
      }
    })();
    </script>
  </body>
</html></textarea>
    <button class="btn btn-default" data-type="run-button" data-target="html-code" style="position: absolute; top: 1em; right: 1em; z-index: 10">Run</button>
  </div>
  <div role="tabpanel" class="tab-pane" data-tab-id="output" style="height: 100%;">
    <div class="split-pane fixed-bottom">
      <div class="split-pane-component top-pane" style="bottom: 3em; margin-bottom: 5px; min-height: 5em;">
        <div data-id="web-preview" data-type="web-preview" data-console="web-preview-console"></div>
      </div>
      <div class="split-pane-divider divider" style="background: #aaa; bottom: 3em; height: 5px;"></div>
      <div class="split-pane-component bottom-pane" style="height: 3em; min-height: 3em;">
        <div data-id="web-preview-console" style="height: 100%" data-type="console"></div>
      </div>
    </div>
  </div>
</div>
<script>
(function(){

  var LiveCode = require('slides/LiveCode');
  var $slideHolder = $(document.currentScript).closest('.slide-frame');

  function init() {
    var liveCode = new LiveCode($slideHolder);

    //manual manage tabs, as we don't want to work with element ids
    $slideHolder.find('a[role=tab]').click(function (e) {
      e.preventDefault();
      var tabId = $(e.target).attr('aria-controls');
      var $tab = $slideHolder.find('[data-tab-id="' + tabId + '"]');
      $slideHolder.find(".nav-tabs .active, .tab-content .active").removeClass("active");
      $(e.target).closest('li').addClass('active');
      $tab.addClass("active");
      liveCode.layout();
    });
    $slideHolder.find('div.split-pane').splitPane();
    $slideHolder.find('div.split-pane').on('resize', function(){
      liveCode.layout();
    });

    //focus webpreview tab on run click
    $slideHolder.find('[data-type="run-button"][data-target="html-code"]').on('click', function(){
      $slideHolder.find('a[role=tab][aria-controls=output]').click();
    });

    requestAnimationFrame(function(){
      $slideHolder.find('a[role=tab]').first().click();
    });
  }

  init();

})();
</script>
</template>
